---
import { Icon } from "astro-icon/components";
---

<!-- There can't be a filter on parent element, or it will break `fixed` -->
<div class="comment-btn-wrapper hidden lg:block">
    <div id="comment-btn" class="comment-btn hide flex items-center rounded-2xl overflow-hidden transition" onclick="scrollToComment()">
        <button aria-label="Scroll to Comments" class="btn-card h-[3.75rem] w-[3.75rem]">
            <Icon name="mingcute:comment-fill" class="mx-auto"></Icon>
        </button>
    </div>
</div>

<style lang="stylus">
.comment-btn-wrapper
    width: 3.75rem
    height: 3.75rem
    position: absolute
    right: 0
    top: 0
    pointer-events: none

.comment-btn
    color: var(--primary)
    font-size: 2.25rem
    font-weight: bold
    border: none
    position: fixed
    bottom: 14.5rem
    opacity: 1
    cursor: pointer
    transform: translateX(5rem)
    pointer-events: auto
    i
        font-size: 1.75rem
    &.hide
        transform: translateX(5rem) scale(0.9)
        opacity: 0
        pointer-events: none
    &:active
      transform: translateX(5rem) scale(0.9)

</style>

<script is:raw is:inline>
function scrollToComment() {
    const giscusContainer = document.getElementById('giscus-container');
    if (giscusContainer) {
        giscusContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}
</script>

<script is:inline>
// 显示/隐藏按钮的逻辑 - 与 BackToTop 类似
function handleScroll() {
    const commentBtn = document.getElementById('comment-btn');
    const giscusContainer = document.getElementById('giscus-container');

    if (!commentBtn) return;

    // 检查是否存在评论区
    const hasCommentSection = !!giscusContainer;

    if (hasCommentSection) {
        // 获取评论区位置
        const rect = giscusContainer.getBoundingClientRect();
        const commentTop = rect.top + window.pageYOffset;

        // 滚动超过一定高度且评论区不在视口内时显示按钮
        const scrollHeight = 200; // 与 BackToTop 相同的触发高度
        const isCommentVisible = rect.top < window.innerHeight && rect.bottom > 0;

        if ((window.pageYOffset > scrollHeight) && !isCommentVisible) {
            commentBtn.classList.remove('hide');
        } else {
            commentBtn.classList.add('hide');
        }
    } else {
        // 没有评论区时隐藏按钮
        commentBtn.classList.add('hide');
    }
}

window.addEventListener('scroll', handleScroll);
window.addEventListener('load', handleScroll);

// Swup 页面切换时重新初始化
document.addEventListener('swup:contentReplaced', () => {
    handleScroll();
});
</script>
