---
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { Icon } from "astro-icon/components";
import { siteConfig } from "../../config";
import { getTotalWords } from "../../utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

const totalWords = await getTotalWords();
const launchDate = siteConfig.launchDate || "2024-01-01";

// 计算运行天数
const calculateRunningDays = () => {
	const launch = new Date(launchDate);
	const today = new Date();
	const diffTime = today.getTime() - launch.getTime();
	const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
	return diffDays;
};

const runningDays = calculateRunningDays();

interface Props {
	class?: string;
	style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout
	name={i18n(I18nKey.siteStats)}
	id="site-stats"
	class={className}
	style={style}
>
	<div class="grid grid-cols-2 gap-3">
		<!-- 运行天数 -->
		<div class="text-center">
			<div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
				<Icon name="material-symbols:event-available" class="text-base"></Icon>
				<span class="text-xs">{i18n(I18nKey.runningDays)}</span>
			</div>
			<div id="site-running-days" class="font-bold text-lg text-neutral-700 dark:text-neutral-300">
				{runningDays}
			</div>
		</div>

		<!-- 总字数 -->
		<div class="text-center border-l border-neutral-200 dark:border-neutral-700">
			<div class="text-xs text-neutral-500 mb-1 flex items-center justify-center gap-1">
				<Icon name="material-symbols:notes" class="text-base"></Icon>
				<span class="text-xs">{i18n(I18nKey.totalWords)}</span>
			</div>
			<div id="site-total-words" class="font-bold text-lg text-neutral-700 dark:text-neutral-300">
				0
			</div>
		</div>
	</div>
</WidgetLayout>

<script define:vars={{ totalWords }}>
	// 数字动画函数
	function animateValue(obj, start, end, duration) {
		let startTimestamp = null;
		const step = (timestamp) => {
			if (!startTimestamp) startTimestamp = timestamp;
			const progress = Math.min((timestamp - startTimestamp) / duration, 1);
			obj.innerHTML = Math.floor(progress * (end - start) + start);
			if (progress < 1) {
				window.requestAnimationFrame(step);
			} else {
				obj.innerHTML = end;
			}
		};
		window.requestAnimationFrame(step);
	}

	// 标记是否正在swup跳转
	let isSwupNavigating = false;

	// 动画显示统计数据
	function loadSiteStats() {
		const runningDaysElement = document.getElementById('site-running-days');
		const totalWordsElement = document.getElementById('site-total-words');

		// 使用 sessionStorage 缓存数据
		const runningDaysCacheKey = 'site-running-days';
		const totalWordsCacheKey = 'site-total-words';

		// 如果不是swup跳转，清除缓存（刷新时需要重新播放动画）
		if (!isSwupNavigating) {
			sessionStorage.removeItem(runningDaysCacheKey);
			sessionStorage.removeItem(totalWordsCacheKey);
		}

		const cachedRunningDays = sessionStorage.getItem(runningDaysCacheKey);
		const cachedTotalWords = sessionStorage.getItem(totalWordsCacheKey);

		// 如果有缓存（swup跳转），先立即显示缓存值
		if (cachedRunningDays !== null && runningDaysElement) {
			runningDaysElement.textContent = cachedRunningDays;
		}
		if (cachedTotalWords !== null && totalWordsElement) {
			totalWordsElement.textContent = cachedTotalWords;
		}

		if (runningDaysElement) {
			const startVal = parseInt(runningDaysElement.textContent) || 0;
			if (startVal > 0) {
				// 只有缓存不存在时才播放动画（刷新或首次加载）
				if (cachedRunningDays === null) {
					animateValue(runningDaysElement, 0, startVal, 1000);
				}
			} else {
				runningDaysElement.textContent = startVal;
			}
			sessionStorage.setItem(runningDaysCacheKey, startVal);
		}

		if (totalWordsElement) {
			const startVal = parseInt(totalWordsElement.textContent) || 0;
			if (startVal !== totalWords) {
				// 只有缓存不存在时才播放动画（刷新或首次加载）
				if (cachedTotalWords === null) {
					animateValue(totalWordsElement, startVal, totalWords, 1000);
				} else if (startVal !== totalWords) {
					totalWordsElement.textContent = totalWords;
				}
			} else {
				totalWordsElement.textContent = totalWords;
			}
			sessionStorage.setItem(totalWordsCacheKey, totalWords);
		}
	}

	document.addEventListener('DOMContentLoaded', loadSiteStats);
	// 监听swup事件
	document.addEventListener('swup:contentReplaced', () => {
		isSwupNavigating = true;
		loadSiteStats();
		setTimeout(() => { isSwupNavigating = false; }, 100);
	});
</script>
